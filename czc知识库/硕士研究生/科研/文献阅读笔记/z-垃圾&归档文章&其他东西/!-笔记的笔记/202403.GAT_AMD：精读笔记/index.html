<!doctype html>
<html lang="en">
<head>
<title>202403.GAT_AMD：精读笔记</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script async type="module">import mermaid from"https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs"</script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-sv0slik/5O0JIPdLBCR2A3XDg/1U3WuDEheZfI/DI5n8Yqc3h5kjrnr46FGBNiUAJF7rE4LHKwQ/SoSLRKAxEA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script async src="https://cdn.jsdelivr.net/npm/lucide@0.115.0/dist/umd/lucide.min.js"></script>
<script>window.addEventListener("load",(()=>{document.querySelectorAll(".callout").forEach((e=>{const t=getComputedStyle(e).getPropertyValue("--callout-icon"),l=t&&t.trim().replace(/^lucide-/,"");if(l){const t=e.querySelector(".callout-title");if(t){const e=document.createElement("div"),c=document.createElement("i");e.appendChild(c),c.setAttribute("icon-name",l),e.setAttribute("class","callout-icon"),t.insertBefore(e,t.firstChild)}}})),lucide.createIcons(),Array.from(document.querySelectorAll(".callout.is-collapsible")).forEach((e=>{e.querySelector(".callout-title").addEventListener("click",(t=>{e.classList.contains("is-collapsed")?e.classList.remove("is-collapsed"):e.classList.add("is-collapsed")}))}))}))</script>
<script async src="https://fastly.jsdelivr.net/npm/force-graph@1.43.0/dist/force-graph.min.js"></script>
<script async src="https://fastly.jsdelivr.net/npm/@alpinejs/persist@3.11.1/dist/cdn.min.js"></script>
<script src="https://fastly.jsdelivr.net/npm/alpinejs@3.11.1/dist/cdn.min.js" async></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism-okaidia.min.css" integrity="sha512-mIs9kKbaw6JZFfSuo+MovjU+Ntggfoj8RwAmJbVXQ5mkAX5LlgETQEweFPI18humSPHymTb5iikEOKWF7I8ncQ==" crossorigin="anonymous" referrerpolicy="no-referrer" async>
<script src="https://fastly.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" async></script>
<link href="/styles/digital-garden-base.css" rel="stylesheet">
<link href="/styles/obsidian-base.css" rel="stylesheet">
<link href="/styles/_theme.d92311c2.css" rel="stylesheet">
<link href="/styles/custom-style.css" rel="stylesheet">
<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="manifest" href="/manifest.webmanifest">
<style></style>
</head>
<body class="theme-dark markdown-preview-view markdown-rendered markdown-preview-section">
<nav class="navbar">
<div class="navbar-inner">
<a href="/" style="text-decoration:none">
<h1 style="margin:15px!important">Digital Garden</h1>
</a>
</div>
</nav>
<main class="content cm-s-obsidian">
<header>
<div class="header-meta">
</div>
</header>
<p><picture src="/img/user/czc%E7%9F%A5%E8%AF%86%E5%BA%93/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/9-%E9%99%84%E4%BB%B6/%E9%99%84%E4%BB%B6/202403.GAT_AMD%EF%BC%9A%E7%B2%BE%E8%AF%BB%E7%AC%94%E8%AE%B0_image.png" alt=""><source media="(max-width:480px)" srcset="/img/optimized/DuawLBNtKi-500.webp" type="image/webp">
<source media="(max-width:480px)" srcset="/img/optimized/DuawLBNtKi-500.jpeg">
<source media="(max-width:1920px)" srcset="/img/optimized/DuawLBNtKi-700.webp" type="image/webp"><source media="(max-width:1920px)" srcset="/img/optimized/DuawLBNtKi-700.jpeg"><img class="" src="/img/user/czc%E7%9F%A5%E8%AF%86%E5%BA%93/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/9-%E9%99%84%E4%BB%B6/%E9%99%84%E4%BB%B6/202403.GAT_AMD%EF%BC%9A%E7%B2%BE%E8%AF%BB%E7%AC%94%E8%AE%B0_image.png" alt="" width=""></picture></p>
<p><a href="202403.GAT_AMD%EF%BC%9A%E5%9F%BA%E4%BA%8E%E5%9B%BE%E6%B3%A8%E6%84%8F%E5%8A%9B%E7%BD%91%E7%BB%9C%E5%92%8C%E5%A4%9A%E6%A8%A1%E6%80%81%E7%89%B9%E5%BE%81%E6%B7%B1%E5%BA%A6%E8%9E%8D%E5%90%88%E7%9A%84Android%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95%20Android%20malware%20detection%20method%20based%20on%20graph%20attention%20networks%20and%20deep%20fusion%20of%20multimodal%20features%EF%BC%88%E7%B2%BE%E8%AF%BB%EF%BC%89.md" target="_blank" class="external-link">202403.GAT_AMD：基于图注意力网络和多模态特征深度融合的Android恶意软件检测方法 Android malware detection method based on graph attention networks and deep fusion of multimodal features（精读）</a></p>
<h1 id="总结用了什么模块" tabindex="-1">总结用了什么模块</h1>
<ul>
<li>数据预处理（apktool、JADX、LibRadar）</li>
<li><strong>构建类集调用图</strong>（CSCG）</li>
<li><strong>主题模型</strong>（TD-IDF、LSI）：对调用图节点使用主题模型提取代码语义特征</li>
<li><strong>Max_GAT</strong>：</li>
<li><strong>深度特征融合网络</strong>：融合两种特征并分类</li>
</ul>
<p>对调用图的生成大小有一个自适应调节的机制存在，让调用图的的大小尽量控制在一个区间内，即避免图过大导致计算开销巨大，又避免图过小导致信息过少</p>
<ul>
<li>本文是采用了很多<strong>模块</strong>组合构成的一个大的恶意软件检测系统</li>
</ul>
<h1 id="动机" tabindex="-1">动机</h1>
<p>安卓恶意软件检测中常见特征包括xml文件中的权限特征和dex文件中的语义和结构特征。恶意软件检测的关键就是如何从这些文件中提取出有效的多维度特征。</p>
<p>作者在2019年提出过一种<strong>主题模型</strong>（topic model），可以有效地提取代码的语义特征。这篇文章在这个模型上继续发展，19年的方法是从apk中提取全局的主题向量，但是恶意软件的恶意行为通常发生在特定的代码区域，全局特征不能准确的表示区域特征。</p>
<p>因此本文构建了一个调用图，图节点对于程序代码的特定单元，并提取节点的主题向量作为节点特征。然后使用GAT模型来提取显著区域特征作为整个图的特征，从而融合节点特征和结构信息</p>
<p>本文的调用图：</p>
<ul>
<li>传统调用图每个节点代表一个函数，但是java的函数可能包含的单词太少从而无法提取到有效的主题特征。因此本文选择使用每个类作为一个节点，进一步将一些类节点合并为类集节点并构建类集调用图（CSCG）。这个方法增强了每个节点的语义信息，并减少调用图的规模</li>
<li>例如图中，代码包含17个java文件，进行处理后可以归档成一个8个节点的CSCG</li>
</ul>
<p>CSCG图特征 和 权限特征 这两个特征的差异很大并且相关性也很低。本文使用深度特征融合网络（三层神经网络）来融合这两种特征并二分类</p>
<h1 id="方法介绍" tabindex="-1">方法介绍</h1>
<h2 id="技术框架" tabindex="-1">技术框架</h2>
<h3 id="数据预处理：" tabindex="-1">数据预处理：</h3>
<ul>
<li>使用LibRadar检测apk包含的第三方库</li>
<li>apktool对apk提取出xml、dex文件
<ul>
<li>使用JADX对dex反编译得到java源代码</li>
<li>根据文章：StursDroid 给出的59个高危权限从xml中提取权限特征</li>
</ul>
</li>
</ul>
<h3 id="主题模型训练" tabindex="-1">主题模型训练</h3>
<ul>
<li>源代码处理：从java源代码中删除检测到的第三方库代码，得到<strong>精简代码</strong></li>
<li>构建训练数据集：使用java词法分析器对源代码进行分段，保留标识符、字符串和数字</li>
<li>训练TD-IDF模型：根据训练数据集训练得到TF-IDF特征向量</li>
<li>训练LSI（潜在语义索引）模型：训练模型并计算全局LSI特征向量</li>
</ul>
<h3 id="cscg" tabindex="-1">CSCG构建：</h3>
<ul>
<li>构建一个类调用图：对每个apk文件，使用Java源代码的公共类构建的类调用图</li>
<li>节点合并：根据Java包结构和第三方库检测结果对节点（类）进行合并，这里每个新节点代表一个类集</li>
<li>建立节点特征：计算每个类集的LSI向量以建立节点特征</li>
</ul>
<h3 id="图特征提取和多特征融合" tabindex="-1">图特征提取和多特征融合</h3>
<ul>
<li>图特征提取：使用带有最大池化层的GAT从CSCG中提取显著区域特征作为图特征，其中涉及语义模态和结构模态的特征融合</li>
<li>三层神经网络对所有特征进行二分类</li>
</ul>
<h3 id="gat-amd" tabindex="-1">GAT_AMD 方法再总结</h3>
<ul>
<li>使用apktool提取出<strong>dex</strong>和<strong>xml</strong>文件</li>
<li>从<strong>xml</strong>文件提取**权限特征</li>
<li>jadx反编译<strong>dex</strong>文件获取<strong>java源码</strong></li>
<li>使用LibRadar检测记录代码中的<strong>第三方库</strong>
<ul>
<li>删除第三方库用于<strong>主题向量</strong>构建</li>
</ul>
</li>
<li>对剩余代码使用Java词法分析器进行<strong>词法分析</strong>
<ul>
<li>对源代码分段</li>
<li>记录所有单词出现的次数，构建单词<strong>字典</strong></li>
</ul>
</li>
<li><strong>主题模型</strong>
<ul>
<li>根据<strong>字典</strong>用<strong>TF-IDF模型</strong>提取<strong>TF-IDF向量</strong>（重要词语向量）</li>
<li>潜在语义索引<strong>LSI</strong>对TF-IDF向量进一步提取<strong>主题向量</strong>（LSI特征向量）</li>
</ul>
</li>
<li><mark>CSCG类集调用图</mark>（创新点）
<ul>
<li>根据java源码构建类调用图</li>
<li>图节点合并</li>
<li>计算节点主题向量作为图中的节点特征</li>
</ul>
</li>
<li><mark>Max-GAT网络提取CSCG特征向量</mark>（创新点）
<ul>
<li>节点特征：节点LSI向量+主题模型LSI特征向量，</li>
<li>边特征：节点调用关系</li>
</ul>
</li>
<li><mark>三层BP神经网络做分类</mark>（创新点）
<ul>
<li>特征向量：权限特征向量、CSCG特征向量</li>
</ul>
</li>
</ul>
<h2 id="cscg-1" tabindex="-1">CSCG构建</h2>
<p>本节介绍：构建方法概述、节点合并方法、合并方法中的自适应节点大小计算。展示节点特征提取和边构建方法。最后举了一个例子</p>
<h3 id="概述" tabindex="-1">概述</h3>
<p>每个类相当于是一个Java文件，被视为一个节点。为了增强节点中的语义信息并控制图的规模，在构造类集调用图的时候设置节点数量上限<code>ts_max</code>和下限<code>tx_min</code></p>
<p>第三方库可能会干扰主题向量的代表性，但是第三方库中也有很小的概率包含恶意行为，完全删除第三方库可能导致调用关系不完整，因此为减小第三方库节点的比例，在合并节点的时候会尝试将每个第三方库合并为一个类集节点，并将非第三方库分离成尽可能多的类集节点。<br>
意思就是当第三方文件数量达到<code>ts_min</code>时，将每个第三方库直接合并为一个类集节点，当第三方文件数量不足的时候，可以适当分离第三方库节点。<br>
这么操作就减少了第三方库的节点比例，减少了第三方库的影响</p>
<p>根据<code>ts_max</code>、<code>tx_min</code>和第三方库检测结果计算每个apk文件的节点尺寸<code>k</code>，确保所有非第三方类集节点包含大致等量的信息。由于apk文件规模差异很大，过大的apk可能会导致规模和结构的信息丢失，这里设计了一种<strong>自适应算法</strong>来自动计算特定apk的节点尺寸<code>k</code>，算法对apk文件的类调用图按比例所见，从而有效保留结构和大小信息</p>
<p>获得合并的类集节点以后，计算节点特征的主题向量，然后将基本类调用图之间的调用关系作为边映射到CSCG</p>
<h3 id="img-src-img-user-czc-e7-9-f-a5-e8-af-86-e5-ba-93-e6-9-d-82-e4-b8-83-e6-9-d-82-e5-85-ab-9-e9-99-84-e4-bb-b6-e9-99-84-e4-bb-b6-e4-b8-be-e4-b8-aa-e6-a0-97-e5-ad-90-png-alt-40" tabindex="-1">类集调用图建立的例子<picture src="/img/user/czc%E7%9F%A5%E8%AF%86%E5%BA%93/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/9-%E9%99%84%E4%BB%B6/%E9%99%84%E4%BB%B6/%E4%B8%BE%E4%B8%AA%E6%A0%97%E5%AD%90.png" alt="40"><source media="(max-width:480px)" srcset="/img/optimized/tOKv5hqExK-500.webp" type="image/webp">
<source media="(max-width:480px)" srcset="/img/optimized/tOKv5hqExK-500.jpeg">
<source media="(max-width:1920px)" srcset="/img/optimized/tOKv5hqExK-700.webp" type="image/webp"><source media="(max-width:1920px)" srcset="/img/optimized/tOKv5hqExK-700.jpeg"><img class="" src="/img/user/czc%E7%9F%A5%E8%AF%86%E5%BA%93/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/9-%E9%99%84%E4%BB%B6/%E9%99%84%E4%BB%B6/%E4%B8%BE%E4%B8%AA%E6%A0%97%E5%AD%90.png" alt="40" width=""></picture></h3>
<p>类集调用图构建一共5个步骤：</p>
<ol>
<li>计算Java文件之间的调用关系，得到基本类调用图</li>
<li>计算java文件之间的合并关系，根据<strong>自适应算法</strong>计算出<code>k值</code><sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>，这里计算出的是<code>2</code>，也就是普通节点中最多包含<code>k</code>个文件。然后进行节点合并，得到7个类集节点<code>(B-H)</code>，类集节点中，<code>H</code>包含第三方库中的全部6个文件，其他节点最多包含<code>k</code>个文件</li>
<li>根据合并后的类集节点计算调用关系</li>
<li>利用<strong>Java词法分析器</strong><sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>对17个类进行分词，得到每个节点对于的单词，然后计算7个节点的<strong>LSI向量</strong></li>
<li>添加全局<strong>LSI特征</strong>作为根节点<code>A</code>，由于<code>BCD</code>没有被调用，这里添加<code>A</code>到<code>BCD</code>的边，然后将调用图转换为无向图作为最终的<strong>CSCG</strong></li>
</ol>
<p>![](/img/user/czc知识库/杂七杂八/9-附件/附件/未命名 4_image.png)</p>
<h2 id="图特征提取" tabindex="-1">图特征提取</h2>
<p>本文提出最大池化层结合GAT模型的名为<strong>Max-GAT</strong>的网络。Max-GAT基于GAT获得的所有节点特征，通过最大池化从每个维度提取最大数量的特征，并将结果作为CSCG特征。</p>
<p>图中，每个CSCG表示为 <code>n*n</code> 邻接矩阵和 <code>n*500</code> 节点特征矩阵，其中500是特征维度，n是节点数量。</p>
<ul>
<li>首先，根据调用关系，识别每个节点的<strong>一阶邻居</strong>，并使用GAT构建多头注意力机制，通过应用多个独立的注意力机制来增加模型的容量。在图5中，注意力头的数量用从一个相邻节点到每个中心节点的箭头数量表示，并作为一个重要参数进行调整。</li>
<li>对于每个注意力头，首先对所有节点特征进行变换，然后对于每个节点，使用相邻节点特征的加权平均来获得更新的特征。将<strong>多头图卷积</strong>得到的特征的平均值作为最终特征。然后得到<code>n*128</code>的特征矩阵，通过<strong>最大池化</strong>，选择<strong>最大特征向量</strong>（<code>128</code>维）作为全图的特征向量。</li>
</ul>
<p>![](/img/user/czc知识库/杂七杂八/9-附件/附件/未命名 4_image-1.png)</p>
<h2 id="and" tabindex="-1">多模态特征融合and二分类</h2>
<p>为了融合图模态和权限模态特征，本文设计了一个多层神经网络。<br>
每层的大小（输出特征维度）在括号中表示。<br>
对于APK文件，首先获取CSCG，然后计算初始<code>128</code>维图模态特征向量（Max_GAT）。<br>
选择<code>59</code>维权限特征向量作为初始权限模态特征向量。两个模态特征之间的尺寸差异不利于特征融合。因此，为每个模态特征引入全连接层以减少这些差异。<br>
然后，构建一个三层神经网络，每层作为融合点，并从 <code>Fc3_Fus</code> 获得 <code>64</code> 维融合特征。通过最终的全连接层 <code>FC_out</code> 得到最终的二分类结果。</p>
<p>![](/img/user/czc知识库/杂七杂八/9-附件/附件/202403.GAT_AMD：基于图注意力网络和多模态特征深度融合的Android恶意软件检测方法 Android malware detection method based on graph attention networks and deep fusion of multimodal features_image-5.png)</p>
<h1 id="时间复杂度分析" tabindex="-1">时间复杂度分析</h1>
<p>这里又相当于是代码的介绍</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>这里设计了一种<strong>自适应算法</strong>来自动计算特定apk的节点尺寸<code>k</code>，算法对apk文件的类调用图按比例所见，从而有效保留结构和大小信息 <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><strong>Java词法分析器</strong>对剩余源代码进行分段。分段结果中仅保留标识符、字符串和数字。每个样本最多保留 100,000 个单词。 <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
</main>
<script>window.location.hash&&document.getElementById(window.location.hash.slice(1)).classList.add("referred"),window.addEventListener("hashchange",(e=>{const t=e.oldURL.split("#");t[1]&&document.getElementById(t[1]).classList.remove("referred");const n=e.newURL.split("#");n[1]&&document.getElementById(n[1]).classList.add("referred")}),!1);const url_parts=window.location.href.split("#"),url=url_parts[0],referrence=url_parts[1];document.querySelectorAll(".cm-s-obsidian > *[id]").forEach((function(e){e.ondblclick=function(e){const t=url+"#"+e.target.id;navigator.clipboard.writeText(t)}}))</script>
<script src="https://fastly.jsdelivr.net/npm/luxon@3.2.1/build/global/luxon.min.js"></script>
<script defer="defer">TIMESTAMP_FORMAT="MMM dd, yyyy h:mm a",document.querySelectorAll(".human-date").forEach((function(e){date=e.getAttribute("data-date")||e.innerText,parsed_date=luxon.DateTime.fromISO(date),null!=parsed_date.invalid&&(parsed_date=luxon.DateTime.fromSQL(date)),null!=parsed_date.invalid&&(parsed_date=luxon.DateTime.fromHTML(date)),e.innerHTML=parsed_date.toFormat(TIMESTAMP_FORMAT)}))</script>
<script>lucide.createIcons({attrs:{class:["svg-icon"]}})</script>
</body>
</html>
